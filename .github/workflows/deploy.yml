name: Deploy to Lightsail via ECR

on:
  push:
    branches:
      - main   # trigger on pushes to main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: eu-west-1
      AWS_ECR_ACCOUNT: 401876438340
      LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
      APP_DIR: ~/peyjabankinn
      COMPOSE_FILE: docker-compose.prod.yml

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to ECR
      run: |
        aws ecr get-login-password --region $AWS_REGION | \
        docker login --username AWS --password-stdin $AWS_ECR_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com

    # --- Backend ---
    - name: Build backend image
      run: |
        docker build -t $API_REPO ./backend
        docker tag $API_REPO:latest $AWS_ECR_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com/$API_REPO:latest

    - name: Push backend image to ECR
      run: |
        docker push $AWS_ECR_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com/$API_REPO:latest

    # --- Frontend ---
    - name: Build frontend image
      run: |
        docker build -t $FRONTEND_REPO ./frontend
        docker tag $FRONTEND_REPO:latest $AWS_ECR_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com/$FRONTEND_REPO:latest

    - name: Push frontend image to ECR
      run: |
        docker push $AWS_ECR_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com/$FRONTEND_REPO:latest

    # --- Deploy to Lightsail ---
    - name: Deploy to Lightsail
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ env.LIGHTSAIL_HOST }}
        user: ubuntu
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        script: |
          set -e
          cd $APP_DIR
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ECR_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com
          docker pull $AWS_ECR_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com/$API_REPO:latest
          docker pull $AWS_ECR_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com/$FRONTEND_REPO:latest
          docker-compose -f docker-compose.prod.yml up -d
          docker-compose exec api python manage.py migrate --noinput
          docker-compose exec api python manage.py collectstatic --noinput

